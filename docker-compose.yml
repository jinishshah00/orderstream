version: "3.8"

services:
  zookeeper:
    image: bitnami/zookeeper:3.9
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    ports: ["2181:2181"]

  kafka:
    image: bitnami/kafka:3.7
    environment:
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - ALLOW_PLAINTEXT_LISTENER=yes
    depends_on: [zookeeper]
    ports: ["9092:9092"]

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    environment:
      - KAFKA_CLUSTERS_0_NAME=local
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9092
    depends_on: [kafka]
    ports: ["8080:8080"]

  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
      POSTGRES_DB: orders
    ports: ["5432:5432"]

  redis:
    image: redis:7
    ports: ["6379:6379"]

  api-gateway:
    build: ./packages/api-gateway
    environment:
      - KAFKA_BROKERS=kafka:9092
      - PORT=3000
      - POSTGRES_URL=postgres://app:app@postgres:5432/orders
      - REDIS_URL=redis://redis:6379
    depends_on: [kafka, postgres, redis]
    ports: ["3000:3000"]

  order-service:
    build: ./packages/order-service
    environment:
      - KAFKA_BROKERS=kafka:9092
      - POSTGRES_URL=postgres://app:app@postgres:5432/orders
    depends_on: [kafka, postgres]

  payment-worker:
    build: ./packages/payment-worker
    environment:
      - KAFKA_BROKERS=kafka:9092
      - PAYMENT_SUCCESS_RATE=1.0
      - PAYMENT_THROW_RATE=0.05
    depends_on: [kafka]
    
  inventory-worker:
    build: ./packages/inventory-worker
    environment:
      - KAFKA_BROKERS=kafka:9092
      - POSTGRES_URL=postgres://app:app@postgres:5432/orders
    depends_on: [kafka, postgres]

